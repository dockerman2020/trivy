pipeline {
agent { label 'kubenode1' }
  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }
  stages {
    stage('Build') {
      steps {
        sh 'docker build -t darinpope/java-web-app:latest .'
      }
    }
    stage('Trivy Scan') {
      steps {
      script{
             // Install trivy
             sh 'echo downloading Trivy ....'
             sh 'curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /tmp latest'
             // sh 'echo Trivy downloaded'
             sh 'curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl > /tmp/html.tpl'
             sh '/tmp/trivy darinpope/java-web-app:latest'
             // sh '/tmp/trivy devopshint/my-app-1.0'
             sh '/tmp/trivy  infoslack/dvwa'
             }
      }
    }
  }
}
